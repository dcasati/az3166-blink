// Refactored main.cpp using modular libraries
#include <Arduino.h>
#include "AZ3166WiFi.h"
#include "FlashConfig.h"
#include "SensorHub.h"
#include "SimpleMQTT.h"
#include "DisplayHelper.h"

// Library instances
FlashConfig config;
SensorHub sensors;
SimpleMQTT mqtt;

// Function prototypes
void configureDevice();
bool checkForConfigurationMode();
String readSerialString(const char* prompt, const char* defaultValue, int maxLength);

void setup() {
    // This function is intentionally empty - using custom main()
}

void loop() {
    // This function is intentionally empty - using custom main()
}

int main() {
    // Initialize Serial
    Serial.begin(115200);
    delay(1000);
    
    Serial.println("=== AZ3166 Sensor Station (Modular Version) ===");
    
    // Initialize display
    DisplayHelper::begin();
    DisplayHelper::print(0, "AZ3166 Station");
    
    // Load configuration
    if (!config.load()) {
        Serial.println("No valid config found, using defaults");
        FlashConfig::DeviceConfig defaultConfig = {
            {'A','Z','3','1'},
            "SensorStation_01",
            "az3166",
            "Garage",
            "YourWiFiNetwork",
            "YourWiFiPassword",
            "mqtt.example.com",
            1883,
            "sensors/az3166",
            0,
            {0, 0, 0}
        };
        config.setDefaults(defaultConfig);
    }
    
    // Check for configuration mode
    if (checkForConfigurationMode()) {
        configureDevice();
    }
    
    // Display current config
    FlashConfig::DeviceConfig& cfg = config.getConfig();
    Serial.println("\n=== CURRENT CONFIGURATION ===");
    Serial.print("Device ID: "); Serial.println(cfg.deviceId);
    Serial.print("WiFi SSID: "); Serial.println(cfg.ssid);
    Serial.print("MQTT Server: "); Serial.println(cfg.mqttServer);
    Serial.print("MQTT Topic: "); Serial.println(cfg.mqttTopic);
    
    DisplayHelper::print(0, cfg.deviceId);
    
    // Initialize sensors
    if (!sensors.begin()) {
        DisplayHelper::showError("Sensor init fail!");
        Serial.println("Failed to initialize sensors!");
        while(1) { delay(1000); }
    }
    
    // Connect to WiFi
    Serial.println("Connecting to WiFi...");
    DisplayHelper::showWiFiConnecting();
    WiFi.begin(cfg.ssid, cfg.password);
    
    int attempts = 0;
    while (WiFi.status() != WL_CONNECTED && attempts < 20) {
        delay(500);
        Serial.print(".");
        attempts++;
    }
    
    if (WiFi.status() == WL_CONNECTED) {
        Serial.println("\nWiFi connected!");
        Serial.print("IP: ");
        Serial.println(WiFi.localIP());
        
        char ipStr[16];
        sprintf(ipStr, "%d.%d.%d.%d", 
                WiFi.localIP()[0], WiFi.localIP()[1], 
                WiFi.localIP()[2], WiFi.localIP()[3]);
        DisplayHelper::showWiFiConnected(ipStr);
    } else {
        DisplayHelper::showError("WiFi failed!");
        Serial.println("WiFi connection failed!");
    }
    
    // Setup MQTT
    mqtt.setServer(cfg.mqttServer, cfg.mqttPort);
    mqtt.setClientId(cfg.deviceId);
    
    // Add DNS mapping if using known server
    if (strcmp(cfg.mqttServer, "mqtt.dcasati.net") == 0) {
        mqtt.addHostnameMapping("mqtt.dcasati.net", IPAddress(172, 16, 5, 241));
    }
    
    // Main loop
    unsigned long lastSensorRead = 0;
    bool mqttConnected = false;
    int counter = 0;
    
    while (1) {
        unsigned long now = millis();
        
        // Try to connect MQTT if not connected
        if (!mqttConnected && WiFi.status() == WL_CONNECTED) {
            DisplayHelper::showMQTTConnecting();
            mqttConnected = mqtt.connect();
            
            if (mqttConnected) {
                DisplayHelper::showMQTTConnected();
            } else {
                DisplayHelper::showError("MQTT failed!");
                delay(10000);  // Wait before retry
            }
        }
        
        // Read sensors every 5 seconds
        if (now - lastSensorRead > 5000) {
            lastSensorRead = now;
            
            Serial.print("\n=== Sensor Reading #");
            Serial.print(counter++);
            Serial.println(" ===");
            
            // Read all sensor data
            SensorHub::SensorData data;
            if (sensors.readAll(data)) {
                // Print to Serial
                sensors.printAll();
                
                // Update display
                DisplayHelper::showSensorData(data.temperature, data.humidity, data.pressure);
                
                // Create and publish JSON
                char jsonPayload[512];
                if (sensors.toJSON(jsonPayload, sizeof(jsonPayload), 
                                  cfg.deviceId, cfg.model, cfg.location)) {
                    Serial.print("JSON: ");
                    Serial.println(jsonPayload);
                    
                    // Publish to MQTT if connected
                    if (mqttConnected) {
                        if (mqtt.publish(cfg.mqttTopic, jsonPayload)) {
                            DisplayHelper::showStatus("MQTT sent!");
                            DisplayHelper::setLED(DisplayHelper::GREEN);
                            delay(100);
                            DisplayHelper::ledOff();
                        } else {
                            DisplayHelper::showStatus("MQTT failed!");
                            mqttConnected = false;
                        }
                    }
                }
            } else {
                Serial.println("Failed to read sensors!");
            }
        }
        
        // Heartbeat LED
        static unsigned long lastBlink = 0;
        static bool ledState = false;
        if (now - lastBlink > 1000) {
            lastBlink = now;
            ledState = !ledState;
            if (ledState && mqttConnected) {
                DisplayHelper::setLED(DisplayHelper::BLUE);
            } else {
                DisplayHelper::ledOff();
            }
        }
        
        delay(100);
    }
    
    return 0;
}

bool checkForConfigurationMode() {
    Serial.println("\nPress 'C' within 5 seconds to enter configuration mode...");
    
    unsigned long startTime = millis();
    while (millis() - startTime < 5000) {
        if (Serial.available()) {
            char c = Serial.read();
            if (c == 'C' || c == 'c') {
                Serial.println("Entering configuration mode...");
                return true;
            }
        }
        delay(100);
    }
    
    Serial.println("Starting with current configuration...");
    return false;
}

String readSerialString(const char* prompt, const char* defaultValue, int maxLength) {
    Serial.print(prompt);
    Serial.print(" [");
    Serial.print(defaultValue);
    Serial.print("]: ");
    
    String input = "";
    unsigned long startTime = millis();
    const unsigned long timeout = 30000;
    
    while (millis() - startTime < timeout) {
        if (Serial.available()) {
            char c = Serial.read();
            if (c == '\n' || c == '\r') {
                break;
            } else if (c == '\b' || c == 127) {
                if (input.length() > 0) {
                    input.remove(input.length() - 1);
                    Serial.print("\b \b");
                }
            } else if (input.length() < maxLength - 1 && c >= 32 && c <= 126) {
                input += c;
                Serial.print(c);
            }
        }
        delay(10);
    }
    
    Serial.println();
    return input.length() > 0 ? input : String(defaultValue);
}

void configureDevice() {
    Serial.println("\n=== DEVICE CONFIGURATION ===");
    
    FlashConfig::DeviceConfig& cfg = config.getConfig();
    
    String newDeviceId = readSerialString("Device ID", cfg.deviceId, sizeof(cfg.deviceId));
    strcpy(cfg.deviceId, newDeviceId.c_str());
    
    String newModel = readSerialString("Device Model", cfg.model, sizeof(cfg.model));
    strcpy(cfg.model, newModel.c_str());
    
    String newLocation = readSerialString("Device Location", cfg.location, sizeof(cfg.location));
    strcpy(cfg.location, newLocation.c_str());
    
    String newSSID = readSerialString("WiFi SSID", cfg.ssid, sizeof(cfg.ssid));
    strcpy(cfg.ssid, newSSID.c_str());
    
    String newPassword = readSerialString("WiFi Password", cfg.password, sizeof(cfg.password));
    strcpy(cfg.password, newPassword.c_str());
    
    String newMqttServer = readSerialString("MQTT Server", cfg.mqttServer, sizeof(cfg.mqttServer));
    strcpy(cfg.mqttServer, newMqttServer.c_str());
    
    String newMqttPort = readSerialString("MQTT Port", String(cfg.mqttPort).c_str(), 8);
    cfg.mqttPort = newMqttPort.toInt();
    if (cfg.mqttPort <= 0 || cfg.mqttPort > 65535) {
        cfg.mqttPort = 1883;
    }
    
    String newMqttTopic = readSerialString("MQTT Topic", cfg.mqttTopic, sizeof(cfg.mqttTopic));
    strcpy(cfg.mqttTopic, newMqttTopic.c_str());
    
    // Save configuration
    if (config.save()) {
        Serial.println("\nConfiguration saved to Flash!");
        DisplayHelper::print(3, "Config saved!");
        DisplayHelper::blinkLED(DisplayHelper::GREEN, 3);
    } else {
        Serial.println("\nFailed to save configuration!");
        DisplayHelper::showError("Save failed!");
    }
}
